import{e as q,u as F,r as i,j as t,L as H,t as $}from"./entry-index-B_BwMGDA.js";import{c as L,b as M,S as R}from"./chunk-SettingCard-tB6Omhiy.js";import{p as y}from"./chunk-flex-BCOyAvOQ.js";import{r as N}from"./chunk-heading-DUyPxxaV.js";import{o as P}from"./chunk-button-BYJQxefP.js";import{n as v,u as S}from"./chunk-callout-DIn4sHDa.js";import{o as V}from"./chunk-separator-H8QRyRNq.js";import"./chunk-text-area-hQYLMo7L.js";import"./chunk-base-button-CCk1VYTx.js";import"./chunk-dropdown-menu-DjJRBXTh.js";import"./chunk-icons-Du45HjA-.js";import"./chunk-require-react-element-nXeqDkbS.js";import"./chunk-index-B6kNq_40.js";import"./chunk-index-CC8wkri2.js";import"./chunk-icon-button-CMpL5Fj6.js";import"./chunk-switch-CZ0Z7J0K.js";import"./chunk-index-BNFPzONB.js";import"./chunk-text-field-DU038-QT.js";import"./chunk-internal-DlW9DyfA.js";import"./chunk-proxy-C6LVNy_K.js";import"./chunk-chevron-down-Dkw6_t5U.js";import"./chunk-index-PbJe1vUH.js";import"./chunk-text-2n0Dx3l-.js";const de=()=>{const{publicInfo:l,refresh:z}=q(),o=l==null?void 0:l.theme,u=(l==null?void 0:l.theme_settings)||{},{t:c}=F(),[j,f]=i.useState(!1),[w,C]=i.useState(!1),[m,k]=i.useState([]),[h,p]=i.useState({}),[x,T]=i.useState(null),[B,O]=i.useState(!0);i.useEffect(()=>{async function e(){var n;if(!o||o==="default"){k([]),p({});return}f(!0),T(null);try{const s=await fetch(`/themes/${o}/komari-theme.json`,{cache:"no-cache"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const a=await s.json();if(!((n=a.configuration)!=null&&n.data)){k([]),p({});return}const r=a.configuration.data;k(r);const _={};r.forEach(d=>{d.type!=="title"&&d.key&&(_[d.key]=u&&u[d.key]!==void 0?u[d.key]:d.default)}),p(_)}catch(s){T(s.message||"加载主题配置失败")}finally{f(!1),O(!1)}}e()},[o,u]);const g=(e,n)=>{p(s=>({...s,[e]:n}))},b=i.useMemo(()=>{const e={};return m.forEach(n=>{if(n.type==="title"||!n.key)return;const s=h[n.key];s!==void 0?e[n.key]=s:n.default!==void 0?e[n.key]=n.default:e[n.key]=""}),e},[m,h]),E=async()=>{if(o){console.log("保存前的 values:",h),console.log("保存前的 payload:",b),C(!0);try{const e=await fetch(`/api/admin/theme/settings?theme=${encodeURIComponent(o)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!e.ok){const n=await e.json().catch(()=>({message:"unknown"}));throw new Error(n.message||`HTTP ${e.status}`)}$.success("保存成功"),z()}catch(e){$.error(`保存失败: ${e.message||e}`)}finally{C(!1)}}};return t.jsxs(y,{direction:"column",gap:"4",className:"p-2 md:p-4",children:[t.jsxs(y,{justify:"between",align:"center",children:[t.jsx(N,{size:"4",children:o?c("theme.manage_with_name",{name:o}):c("theme.manage")}),m.length>0&&t.jsx(P,{onClick:E,disabled:w,children:c("common.save")})]}),x&&t.jsx(v,{color:"red",children:t.jsx(S,{children:x})}),j&&B&&t.jsx(H,{}),!j&&o==="default"&&t.jsx(v,{children:t.jsx(S,{children:c("theme.default_no_config")})}),!j&&!x&&m.length===0&&o!=="default"&&t.jsx(v,{children:t.jsx(S,{children:c("theme.no_config")})}),t.jsx(V,{size:"4"}),t.jsx(y,{direction:"column",gap:"3",children:m.map((e,n)=>{if(e.type==="title")return t.jsx(N,{size:"3",className:"mt-4",children:e.name||"标题"},n);if(!e.key)return null;const s=h[e.key];switch(e.type){case"switch":return t.jsx(R,{title:e.name,description:e.help,defaultChecked:!!s,onChange:a=>g(e.key,a)},e.key);case"select":{const a=(e.options||"").split(",").map(r=>r.trim()).filter(Boolean).map(r=>({value:r}));return t.jsx(M,{title:e.name,description:e.help,value:s,options:a,OnSave:r=>g(e.key,r),label:s||"选择"},e.key)}case"number":return t.jsx(L,{title:e.name,description:e.help,type:"number",showSaveButton:!1,value:s!==void 0?String(s):"",onChange:a=>g(e.key,a.target.value===""?void 0:Number(a.target.value))},e.key);case"string":default:return t.jsx(L,{title:e.name,description:e.help,value:s!==void 0?String(s):"",required:e.required,showSaveButton:!1,onChange:a=>g(e.key,a.target.value)},e.key)}})}),m.length>0&&t.jsx(y,{children:t.jsx(P,{onClick:E,disabled:w,children:c("common.save")})})]})};export{de as default};
