import{u as C,R as n,j as s,L as b,t as A}from"./entry-index-B_BwMGDA.js";import{d as v,S as w,b as E,c as T}from"./chunk-SettingCard-tB6Omhiy.js";import{u as P,a as p}from"./chunk-api-h1eiz4mP.js";import{r as N}from"./chunk-renderProviders-z_fdSrsM.js";import{p as k}from"./chunk-text-2n0Dx3l-.js";import{o as R}from"./chunk-button-BYJQxefP.js";import"./chunk-text-area-hQYLMo7L.js";import"./chunk-base-button-CCk1VYTx.js";import"./chunk-flex-BCOyAvOQ.js";import"./chunk-dropdown-menu-DjJRBXTh.js";import"./chunk-icons-Du45HjA-.js";import"./chunk-require-react-element-nXeqDkbS.js";import"./chunk-index-B6kNq_40.js";import"./chunk-index-CC8wkri2.js";import"./chunk-icon-button-CMpL5Fj6.js";import"./chunk-switch-CZ0Z7J0K.js";import"./chunk-index-BNFPzONB.js";import"./chunk-text-field-DU038-QT.js";import"./chunk-internal-DlW9DyfA.js";import"./chunk-proxy-C6LVNy_K.js";import"./chunk-chevron-down-Dkw6_t5U.js";import"./chunk-index-PbJe1vUH.js";function rt(){const{t:e}=C(),{settings:i,loading:l,error:c}=P(),[h,m]=n.useState({}),[r,u]=n.useState([]),[o,S]=n.useState(""),[O,f]=n.useState({}),[y,d]=n.useState(!1),[_,a]=n.useState("");n.useEffect(()=>{l||(d(!0),fetch("/api/admin/settings/oidc").then(t=>t.json()).then(t=>{if(t.status==="success"&&t.data){m(t.data);const g=Object.keys(t.data);u(g);const j=i.o_auth_provider&&g.includes(i.o_auth_provider)?i.o_auth_provider:"";S(j)}else a(t.message||"获取登录接口信息失败")}).catch(()=>a("获取登录接口信息失败")).finally(()=>d(!1)))},[l,i.o_auth_provider]),n.useEffect(()=>{o&&(d(!0),fetch(`/api/admin/settings/oidc?provider=${o}`).then(t=>t.json()).then(t=>{if(t.status==="success"&&t.data)try{f(JSON.parse(t.data.addition||"{}"))}catch{f({})}else a(t.message||"获取设置失败")}).catch(()=>a("获取设置失败")).finally(()=>d(!1)))},[o]);const L=async t=>{d(!0),a("");const g={name:o,addition:JSON.stringify(t)};try{const x=await(await fetch("/api/admin/settings/oidc",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)})).json();x.status!=="success"?a(x.message||"保存失败"):f(t)}catch{a("保存失败")}d(!1)};return l||!y&&r.length===0&&!_?s.jsx(b,{}):c?s.jsx(k,{color:"red",children:c}):_?s.jsx(k,{color:"red",children:_}):s.jsxs(s.Fragment,{children:[s.jsx(v,{children:e("settings.sign_on.title")}),s.jsx(w,{title:e("settings.sign_on.disable_password","禁止密码登录"),defaultChecked:i.disable_password_login,onChange:async t=>{await p({disable_password_login:t},e)}}),s.jsx(v,{children:e("settings.sso.title")}),s.jsx(w,{title:e("settings.sso.enable","启用单点登录"),defaultChecked:i.o_auth_enabled,description:e("settings.sso.enable_description","启用单点登录功能"),onChange:async t=>{await p({o_auth_enabled:t},e)}}),s.jsx(E,{title:String(e("settings.sso.provider")),description:String(e("settings.sso.provider_description")),options:r.map(t=>({value:t,label:t})),value:o,OnSave:async t=>{t!==o&&(await p({o_auth_provider:t},e),S(t))}}),y?s.jsx(b,{}):N({currentProvider:o,providerDefs:h,providerValues:O,translationPrefix:"settings.sso."+o,title:e("settings.sso.provider_fields"),description:e("settings.sso.provider_fields_description"),footer:e("settings.sso.callback_url_tips",{url:`${window.location.origin}/api/oauth_callback`}),setProviderValues:f,handleSave:L,t:e}),s.jsx(v,{children:"API"}),s.jsx(V,{})]})}const V=()=>{const{settings:e}=P(),{t:i}=C(),[l,c]=n.useState((e==null?void 0:e.api_key)||""),h=()=>{const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let u="komari-";for(let o=0;o<32;o++)u+=r.charAt(Math.floor(Math.random()*r.length));return u},m=()=>{const r=h();c(r)};return n.useEffect(()=>{e!=null&&e.api_key&&c(e.api_key)},[e==null?void 0:e.api_key]),s.jsx(T,{title:i("settings.api.title"),description:i("settings.api.description"),value:l,onChange:r=>c(r.target.value),OnSave:async r=>{if(!r){await p({api_key:""},i);return}if(r.length<12){A.error(i("settings.api.key_length_error"));return}await p({api_key:r},i)},children:s.jsx("div",{className:"flex flex-row gap-2 justify-start items-center",children:s.jsx(R,{variant:"soft",color:"green",onClick:m,children:i("common.generate")})})})};export{rt as default};
