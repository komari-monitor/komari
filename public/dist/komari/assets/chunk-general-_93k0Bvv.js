import{u as b,R as l,j as t,L as P,t as f}from"./entry-index-B_BwMGDA.js";import{u as R,a as g}from"./chunk-api-h1eiz4mP.js";import{a as h,d as S,S as x,b as G,g as O,c as k}from"./chunk-SettingCard-tB6Omhiy.js";import{p as y}from"./chunk-flex-BCOyAvOQ.js";import{r as A}from"./chunk-text-area-hQYLMo7L.js";import{u as V}from"./chunk-text-field-DU038-QT.js";import{o as v}from"./chunk-button-BYJQxefP.js";import{f as M}from"./chunk-unitHelper-BjgrQHpY.js";import{p as B}from"./chunk-code-DzvxLTl9.js";import{p as L}from"./chunk-text-2n0Dx3l-.js";import"./chunk-dropdown-menu-DjJRBXTh.js";import"./chunk-base-button-CCk1VYTx.js";import"./chunk-icons-Du45HjA-.js";import"./chunk-require-react-element-nXeqDkbS.js";import"./chunk-index-B6kNq_40.js";import"./chunk-index-CC8wkri2.js";import"./chunk-icon-button-CMpL5Fj6.js";import"./chunk-switch-CZ0Z7J0K.js";import"./chunk-index-BNFPzONB.js";import"./chunk-proxy-C6LVNy_K.js";import"./chunk-chevron-down-Dkw6_t5U.js";import"./chunk-index-PbJe1vUH.js";import"./chunk-internal-DlW9DyfA.js";function F({title:e="",description:a="",defaultOpen:p=!1,items:o,onSave:_,isSaving:u,children:n,onChange:d}){const{t:s}=b(),[i,c]=l.useState(()=>o.reduce((r,m)=>(r[m.tag]=m.defaultValue||"",r),{})),[z,j]=l.useState(!1),I=u!==void 0?u:z,w=(r,m)=>{c(E=>{const C={...E,[r]:m};return d&&d(C),C})},T=async()=>{u===void 0&&j(!0);try{await _(i)}finally{u===void 0&&j(!1)}};return t.jsxs(h,{title:e,description:a,defaultOpen:p,children:[l.Children.map(n,r=>l.isValidElement(r)&&r.type===h.Header?r:null),t.jsxs(y,{direction:"column",gap:"2",className:"w-full",children:[o.map(r=>t.jsxs(l.Fragment,{children:[t.jsx("label",{className:"text-sm font-semibold",children:r.label}),r.type==="long"?t.jsx(A,{className:"w-full",defaultValue:r.defaultValue,value:i[r.tag],placeholder:r.placeholder,disabled:r.disabled,onChange:m=>w(r.tag,m.target.value),resize:"vertical",ref:void 0}):t.jsx(V,{className:"w-full",defaultValue:r.defaultValue,value:i[r.tag],placeholder:r.placeholder,disabled:r.disabled,type:r.number?"number":"text",onChange:m=>w(r.tag,m.target.value),ref:void 0})]},r.tag)),l.Children.map(n,r=>l.isValidElement(r)&&r.type===h.Header?null:r),t.jsx("div",{children:t.jsx(v,{variant:"solid",className:"mt-2",onClick:T,disabled:I,children:s("save")})})]})]})}function ue(){const{t:e}=b(),{settings:a,loading:p,error:o}=R(),[_,u]=l.useState(null),[n,d]=l.useState(null);return l.useEffect(()=>{const s=parseInt(a.ping_record_preserve_time||"30",10),i=parseInt(a.record_preserve_time||"30",10);if(isNaN(s)||isNaN(i)){d("0");return}else d(N(s,i))},[a.ping_record_preserve_time,a.record_preserve_time]),p?t.jsx(P,{text:"creeper?"}):o?t.jsx(L,{color:"red",children:o}):t.jsxs(t.Fragment,{children:[t.jsx(S,{children:e("settings.general.auto_discovery")}),t.jsx(H,{settings:a}),t.jsx("label",{className:"text-xl font-bold",children:e("settings.geoip.title")}),t.jsx(x,{title:e("settings.geoip.enable_title"),description:e("settings.geoip.enable_description"),defaultChecked:a.geo_ip_enabled,onChange:async s=>{await g({geo_ip_enabled:s},e)}}),t.jsx(G,{title:e("settings.geoip.provider_title"),description:e("settings.geoip.provider_description"),defaultValue:a.geo_ip_provider,options:[{value:"empty",label:e("common.none")},{value:"mmdb",label:"MaxMind"},{value:"ip-api",label:"ip-api.com"},{value:"geojs",label:"geojs.io"},{value:"ipinfo",label:"ipinfo.io"}],OnSave:async s=>{await g({geo_ip_provider:s},e)}}),t.jsx(O,{title:e("settings.geoip.update_title","更新 GeoIP 数据库"),onClick:async()=>{const i=await(await fetch("/api/admin/update/mmdb",{method:"POST"})).json();i.status==="success"?f.success(e("settings.geoip.update_success","GeoIP 数据库更新成功")):f.error(i.message||e("settings.geoip.update_error","更新 GeoIP 数据库失败"))},children:e("common.update","更新")}),t.jsx(h,{title:e("settings.geoip.test_title"),description:e("settings.geoip.test_description"),children:t.jsxs(y,{className:"w-full gap-2",direction:"column",children:[t.jsx(V,{placeholder:"1.1.1.1 or 2606:4700:4700::1111"}),t.jsx("div",{children:t.jsx(v,{variant:"solid",onClick:async()=>{const s=document.querySelector("input[placeholder]").value,c=await(await fetch(`/api/admin/test/geoip?ip=${s}`)).json();u(JSON.stringify(c.data,null,2)||"无结果")},children:e("settings.geoip.test_button","测试")})})," ",t.jsx(y,{className:"w-full",children:_&&t.jsx(B,{className:"w-full whitespace-pre-wrap text-sm p-3 rounded-md overflow-auto max-h-96",style:{display:"block"},children:_})})]})}),t.jsx("label",{className:"text-xl font-bold",children:e("settings.record.title")}),t.jsx(x,{title:e("settings.record.enabled"),description:e("settings.record.enabled_description"),defaultChecked:a.record_enabled,onChange:async s=>{await g({record_enabled:s},e)}}),t.jsx(F,{defaultOpen:!0,title:e("settings.record.record_preserve_time"),description:e("settings.record.record_preserve_time_description"),items:[{tag:"record_preserve_time",label:e("settings.record.record_preserve_time_label"),type:"short",placeholder:"30",defaultValue:a.record_preserve_time||"30",number:!0},{tag:"ping_record_preserve_time",label:e("settings.record.ping_record_preserve_time"),type:"short",placeholder:"30",defaultValue:a.ping_record_preserve_time||"30",number:!0}],onSave:async s=>{const i=parseInt(s.record_preserve_time,10),c=parseInt(s.ping_record_preserve_time,10);if(isNaN(i)||isNaN(c)){f.error(e("settings.record.invalid_preserve_time"));return}await g({record_preserve_time:i,ping_record_preserve_time:c},e)},onChange:s=>{const i=parseInt(s.record_preserve_time,10),c=parseInt(s.ping_record_preserve_time,10);if(isNaN(i)||isNaN(c)){d("0");return}d(N(c,i))},children:t.jsx("label",{className:"text-sm text-muted-foreground",children:e("settings.record.expected_usage",{space:n})})}),t.jsx(S,{children:e("settings.nezha.title")}),t.jsx("label",{className:"text-sm text-muted-foreground -mt-4",children:e("settings.nezha.description")}),t.jsx(x,{title:e("settings.nezha.enabled"),description:e("settings.nezha.enabled_description"),defaultChecked:a.nezha_compat_enabled,onChange:async s=>{await g({nezha_compat_enabled:s},e)}}),t.jsx(k,{title:e("settings.nezha.listen"),description:e("settings.nezha.listen_description"),defaultValue:a.nezha_compat_listen||"",placeholder:"0.0.0.0:5555",OnSave:async s=>{await g({nezha_compat_listen:s},e)}})]})}function N(e,a){let p=0,o=0;return p=e*3600,a<=4?o=a*1*1024*60:(o=4*1*1024*60,o+=(a-4)*4*1024),M(p+o)}const H=({settings:e})=>{const{t:a}=b(),[p,o]=l.useState((e==null?void 0:e.auto_discovery_key)||""),_=()=>{const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let d="";for(let s=0;s<24;s++)d+=n.charAt(Math.floor(Math.random()*n.length));return d},u=()=>{const n=_();o(n)};return l.useEffect(()=>{e!=null&&e.auto_discovery_key&&o(e.auto_discovery_key)},[e==null?void 0:e.auto_discovery_key]),t.jsx(k,{title:a("settings.general.auto_discovery_key"),description:a("settings.general.auto_discovery_key_description"),value:p,onChange:n=>o(n.target.value),OnSave:async n=>{if(!n){await g({auto_discovery_key:""},a);return}if(n.length<12){f.error(a("settings.api.key_length_error"));return}await g({auto_discovery_key:n},a)},children:t.jsxs("div",{className:"flex flex-row gap-2 justify-start items-center",children:[t.jsx(v,{variant:"soft",color:"green",onClick:u,children:a("common.generate")}),t.jsx(v,{variant:"soft",color:"mint",onClick:()=>{window.open("https://komari-document.pages.dev/install/agent-ad.html","_blank")},children:a("common.help")})]})})};export{ue as default};
