import{c as V,u as fe,r as i,w as ge,e as xe,j as e,L as je,t as p}from"./entry-index-B_BwMGDA.js";import{u as we}from"./chunk-api-h1eiz4mP.js";import{a as ye,U as ve}from"./chunk-UploadDialog-D1GjjIJt.js";import{S as D}from"./chunk-settings-CGD2bVo_.js";import{S as _e}from"./chunk-square-arrow-out-up-right-Wswgb_n7.js";import{p as d}from"./chunk-text-2n0Dx3l-.js";import{p as f}from"./chunk-box-B1i8JWQr.js";import{p as l}from"./chunk-flex-BCOyAvOQ.js";import{o as u}from"./chunk-button-BYJQxefP.js";import{o as ke}from"./chunk-grid-DgdHaNlS.js";import{o as Ne}from"./chunk-card-CkJ954zg.js";import{e as be}from"./chunk-badge-CENIML0j.js";import{o as ze}from"./chunk-icon-button-CMpL5Fj6.js";import{s as O,p as L,g as $,D as P,m as K}from"./chunk-dialog-DNX9FVqx.js";import"./chunk-base-button-CCk1VYTx.js";import"./chunk-heading-DUyPxxaV.js";import"./chunk-require-react-element-nXeqDkbS.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],A=V("image",Se);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Q=V("refresh-cw",Ue),Xe=()=>{const{t:s}=fe(),[w,S]=i.useState([]),[Y,Z]=i.useState(!0),[ee,y]=i.useState(!1),[te,g]=i.useState(0),[H,v]=i.useState(null),[M,q]=i.useState(null),[R,se]=i.useState(null),[ae,U]=i.useState(!1),[a,J]=i.useState(null),[re,x]=i.useState(!1),[oe,N]=i.useState(!1),[_,W]=i.useState(null),[ne,b]=i.useState(!1),[B,F]=i.useState(null),[X,I]=i.useState(!1),{settings:T,loading:E,refetch:G}=we(),m=T==null?void 0:T.theme,ie=ge(),{publicInfo:j}=xe(),[le,k]=i.useState(!1);i.useEffect(()=>{let t=!1;async function r(){const o=m||(j==null?void 0:j.theme);if(!o||o==="default"){k(!1);return}try{const h=await fetch(`/themes/${o}/komari-theme.json`,{cache:"no-cache"});if(!h.ok){k(!1);return}const n=await h.json().catch(()=>null);!t&&n&&n.configuration&&Array.isArray(n.configuration.data)&&n.configuration.data.length>0?k(!0):t||k(!1)}catch{t||k(!1)}}return r(),()=>{t=!0}},[m,j==null?void 0:j.theme]);const ce=Y||E||!m,z=async()=>{try{const t=await fetch("/api/admin/theme/list");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=(await t.json()).data||[];o.some(c=>c.short==="default")||o.unshift({id:"default",name:s("theme.default_theme"),short:"default",description:s("theme.default_description"),author:"Akizon77",version:"1.0.0",preview:"/assets/edit_117847723_p0.png",active:m==="default",createdAt:new Date().toISOString()});const n=o.map(c=>({...c,active:c.short===m}));S(n)}catch(t){se(t instanceof Error?t.message:"Failed to fetch themes")}finally{Z(!1)}},de=async t=>{if(!t.name.endsWith(".zip")){p.error(s("theme.invalid_file_type"));return}y(!0),g(0);const r=new FormData;return r.append("file",t),new Promise((o,h)=>{const n=new XMLHttpRequest;v(n),n.upload.addEventListener("progress",c=>{if(c.lengthComputable){const ue=c.loaded/c.total*100;g(Math.round(ue))}}),n.addEventListener("load",async()=>{if(n.status===413){p.error(s("theme.uploda_413_content_too_large")),y(!1),g(0),v(null);return}if(n.status>=200&&n.status<300)try{JSON.parse(n.responseText),p.success(s("theme.upload_success")),U(!1),g(0),await z(),o()}catch(c){p.error(s("theme.upload_failed")+": Parse error"),h(c)}else try{const c=JSON.parse(n.responseText);throw new Error(c.message||"Upload failed")}catch(c){p.error(s("theme.upload_failed")+": "+(c instanceof Error?c.message:"Unknown error")),h(c)}y(!1),v(null)}),n.addEventListener("error",()=>{p.error(s("theme.upload_failed")+": Network error"),y(!1),g(0),v(null),h(new Error("Network error"))}),n.addEventListener("abort",()=>{p.error(s("theme.upload_failed")+": Upload cancelled"),y(!1),g(0),v(null),h(new Error("Upload cancelled"))}),n.open("PUT","/api/admin/theme/upload"),n.send(r)})},he=()=>{H&&H.abort()},C=async t=>{try{q(t);const r=await fetch(`/api/admin/theme/set?theme=${t}`);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);await G(),S(h=>h.map(n=>({...n,active:n.short===t})));const o=w.find(h=>h.short===t);console.log(o),o&&o.configuration&&o.configuration.data&&window.location.reload(),p.success(s("theme.set_success"))}catch(r){p.error(s("theme.set_failed")+": "+(r instanceof Error?r.message:"Unknown error"))}finally{q(null)}},pe=async t=>{try{I(!0);const o=await fetch("/api/admin/theme/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({short:t,useOriginalUrl:!0})});if(!o.ok){const h=await o.json();throw new Error(h.message||"Update failed")}await z(),b(!1),x(!1),p.success(s("theme.update_success"))}catch(r){p.error(s("theme.update_failed")+": "+(r instanceof Error?r.message:"Unknown error"))}finally{I(!1)}},me=async t=>{try{t===m&&(await C("default"),await G());const r=await fetch("/api/admin/theme/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({short:t})});if(!r.ok){const o=await r.json();throw new Error(o.message||"Delete failed")}await z(),N(!1),x(!1),p.success(s("theme.delete_success"))}catch(r){p.error(s("theme.delete_failed")+": "+(r instanceof Error?r.message:"Unknown error"))}};return i.useEffect(()=>{z()},[m]),i.useEffect(()=>{!E&&w.length>0&&S(t=>t.map(r=>({...r,active:r.short===m})))},[m,E,w.length]),ce?e.jsx(je,{}):R?e.jsx(d,{color:"red",children:R}):e.jsxs(f,{className:"p-6 space-y-6",children:[e.jsxs(l,{justify:"between",align:"center",gap:"3",wrap:"wrap",children:[e.jsx(d,{size:"6",weight:"bold",children:s("theme.title")}),e.jsxs(l,{gap:"2",children:[le&&e.jsxs(u,{variant:"soft",className:"gap-2",onClick:()=>ie("/admin/theme_managed"),children:[e.jsx(D,{size:16}),`${m}设置`]}),e.jsxs(u,{onClick:()=>U(!0),className:"gap-2",children:[e.jsx(ye,{size:16}),s("theme.upload")]})]})]}),w.length===0?e.jsxs(f,{className:"text-center py-12",children:[e.jsx(A,{size:64,className:"mx-auto text-gray-400 mb-4"}),e.jsx(d,{size:"4",color:"gray",className:"mb-2",children:s("theme.no_themes")}),e.jsx(d,{size:"2",color:"gray",children:s("theme.upload_first_theme")})]}):e.jsx(ke,{columns:{initial:"1",sm:"2",md:"3",lg:"4"},gap:"4",children:w.map(t=>e.jsxs(Ne,{className:"relative group hover:shadow-lg transition-all duration-200",children:[e.jsxs(f,{onClick:()=>{x(!0),J(t)},className:"aspect-video bg-gradient-to-br rounded-t-lg overflow-hidden relative ",children:[t.preview?e.jsx("img",{src:t.short==="default"?"/assets/edit_117847723_p0.png":`/themes/${t.short}/${t.preview}`,alt:t.name,className:"w-full h-full object-cover",onError:r=>{var o;r.currentTarget.style.display="none",(o=r.currentTarget.nextElementSibling)==null||o.classList.remove("hidden")}}):null,e.jsx(l,{align:"center",justify:"center",className:`w-full h-full ${t.preview&&t.short!=="default"?"hidden":""}`,children:e.jsx(A,{size:48,className:"text-gray-400"})}),e.jsx(f,{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center",children:e.jsx(l,{gap:"2"})}),t.active&&e.jsx(be,{color:"green",className:"absolute top-2 right-2 px-2 py-1 text-xs",children:s("theme.active")})]}),e.jsxs(l,{onClick:()=>{x(!0),J(t)},direction:"column",className:"p-4 space-y-2",children:[e.jsx(d,{weight:"bold",size:"3",children:t.name}),e.jsxs(l,{justify:"between",align:"center",children:[e.jsxs(d,{size:"1",color:"gray",children:["by ",t.author]}),e.jsxs(d,{size:"1",color:"gray",children:["v",t.version]})]})]}),e.jsx(l,{justify:"end",align:"center",children:!t.active&&e.jsx(ze,{size:"2",variant:"ghost",onClick:()=>C(t.short),disabled:M===t.short,children:M===t.short?e.jsx(f,{className:"animate-spin",children:e.jsx(D,{size:16})}):e.jsx(D,{size:16})})})]},t.id))}),e.jsx(ve,{open:ae,onOpenChange:U,title:s("theme.upload_theme"),description:s("theme.upload_description"),accept:".zip",dragDropText:s("theme.drag_drop"),clickToBrowseText:s("theme.or_click_to_browse"),hintText:s("theme.zip_files_only"),uploading:ee,progress:te,uploadingText:s("theme.uploading"),cancelUploadLabel:s("common.cancel"),onCancelUpload:he,onFileSelected:t=>de(t),closeLabel:s("common.cancel")}),e.jsx(O,{open:re,onOpenChange:x,children:e.jsxs(L,{maxWidth:"800px",children:[e.jsx($,{children:a==null?void 0:a.name}),e.jsxs(f,{className:"space-y-4 mt-4",children:[e.jsx(f,{className:"aspect-video bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden relative",children:a!=null&&a.preview&&a.short!=="default"?e.jsx("img",{src:`/themes/${a.short}/${a.preview}`,alt:a.name,className:"w-full h-full object-cover"}):(a==null?void 0:a.short)==="default"?e.jsx("img",{src:"/assets/edit_117847723_p0.png",alt:a.name,className:"w-full h-full object-cover"}):e.jsx(l,{align:"center",justify:"center",className:"w-full h-full",children:e.jsx(A,{size:64,className:"text-gray-400"})})}),e.jsxs(l,{direction:"column",children:[e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:s("theme.author")}),e.jsx(d,{size:"3",children:a==null?void 0:a.author})]}),e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:s("theme.version")}),e.jsx(d,{size:"3",children:a==null?void 0:a.version})]}),e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:s("theme.description")}),e.jsx(d,{size:"3",children:a==null?void 0:a.description})]}),(a==null?void 0:a.url)&&e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:"URL"}),e.jsx(d,{size:"1",className:"overflow-hidden text-ellipsis",children:a==null?void 0:a.url}),e.jsx("a",{href:a.url,target:"_blank",children:e.jsx(_e,{size:12})})]})]})]}),e.jsxs(l,{gap:"3",mt:"4",justify:"end",children:[e.jsx(P,{children:e.jsx(u,{variant:"soft",color:"gray",children:s("common.close")})}),a&&!a.active&&e.jsx(u,{onClick:()=>{C(a.short),x(!1)},children:s("theme.set_active")}),a&&a.short!=="default"&&e.jsxs(u,{variant:"soft",color:"blue",onClick:()=>{F(a),b(!0)},className:"gap-2",children:[e.jsx(Q,{size:16}),s("theme.update")]}),a&&a.short!=="default"&&e.jsx(u,{size:"2",variant:"solid",color:"red",onClick:()=>{W(a),N(!0)},children:s("common.delete")})]})]})}),e.jsx(O,{open:oe,onOpenChange:N,children:e.jsxs(L,{maxWidth:"400px",children:[e.jsx($,{children:s("theme.confirm_delete")}),e.jsx(K,{children:s("theme.delete_warning",{themeName:_==null?void 0:_.name})}),e.jsxs(l,{gap:"3",mt:"4",justify:"end",children:[e.jsx(P,{children:e.jsx(u,{variant:"soft",color:"gray",children:s("common.cancel")})}),e.jsx(u,{color:"red",onClick:async()=>{_&&(await me(_.short),N(!1),W(null))},children:s("common.delete")})]})]})}),e.jsx(O,{open:ne,onOpenChange:b,children:e.jsxs(L,{maxWidth:"500px",children:[e.jsx($,{children:s("theme.update_theme")}),e.jsx(K,{children:s("theme.update_description")}),e.jsx(f,{className:"space-y-4 mt-4",children:e.jsx(l,{direction:"column",gap:"2",children:e.jsx(d,{size:"2",color:"gray",className:"mt-2",children:s("theme.update_mode_auto_description")})})}),e.jsxs(l,{gap:"3",mt:"4",justify:"end",children:[e.jsx(P,{children:e.jsx(u,{variant:"soft",color:"gray",children:s("common.cancel")})}),e.jsxs(u,{color:"blue",disabled:X,onClick:async()=>{B&&(await pe(B.short),b(!1),F(null))},children:[X?e.jsx(f,{className:"animate-spin mr-2",children:e.jsx(Q,{size:16})}):null,s("theme.update")]})]})]})}),e.jsxs("label",{className:"text-muted-foreground text-sm",children:[s("theme.find_more"),e.jsx("a",{href:"https://komari-document.pages.dev/community/theme.html",target:"_blank",className:"text-accent-9",children:s("theme.theme_link")})]})]})};export{Xe as default};
